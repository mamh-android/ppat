<?xml version="1.0"?>

<project name="lpm" basedir="." default="result">
    <include file="${user.dir}/config/command.xml"/>
    <taskdef resource="net/sf/antcontrib/antcontrib.properties"/>
    <taskdef resource="net/sf/antcontrib/antlib.xml"/>

    <target name="prepare">
        <EnterUboot/>
        <PowerCtrlUSB flag="off"/>
    </target>

    <target name="run" depends="prepare">
        <for trim="true" list="${VL}" param="volt"><!-- available available voltage -->
            <sequential>
                <for trim="true" list="${CPU_FREQ}" param="cpu"><!-- available cpu frequencies -->
                    <sequential>
                        <for trim="true" list="${DDR_FREQ}" param="ddr"><!-- available ddr frequencies -->
                            <sequential>
                                <for trim="true" list="${AXI_FREQ}" param="axi"><!-- available axi frequencies -->
                                    <sequential>
                                        <for trim="true" list="${CPU_CORENUM}" param="coreNum">
                                            <sequential>
        										<!-- set property for save to database-->
                                                <SystemProperty key="ddr" value="@{ddr}"/>
                                                <SystemProperty key="cpu" value="@{cpu}"/>
                                                <SystemProperty key="axi" value="@{axi}"/>
                                                <SystemProperty key="volt" value="@{volt}"/>
								        		<!-- end of set property -->

        										<!-- property for email report -->
                                                <PropertyMap key="volt" value="@{volt}"/>
                                                <PropertyMap key="lpm" value="c1mp0"/>
                                                <PropertyMap key="cpu" value="@{cpu}"/>
                                                <PropertyMap key="ddr" value="@{ddr}"/>
                                                <PropertyMap key="axi" value="@{axi}"/>
                                                <PropertyMap key="coreNum" value="@{coreNum}"/>
										        <!-- end of property for email report -->

                                                <echo message="set prepare command"/>
                                                <SerialPortCmd cmd="cp_d2" />
                                                <sleep seconds="5"/>
                                                <SerialPortCmd cmd="amp 1" />
                                                <sleep seconds="5"/>
                                                <SerialPortCmd cmd="amp 2" />
                                                <sleep seconds="5"/>
                                                <SerialPortCmd cmd="amp 3" />
                                                <sleep seconds="5"/>
                                                <SerialPortCmd cmd="setvolt vcc_main dvc0011 1400" />
                                                <sleep seconds="5"/>

                                                <echo message="set cpu: @{cpu}"/>
                                                <SerialPortCmd cmd="setcpurate @{cpu}"/>
                                                <sleep seconds="5"/>
                                                <SerialPortCmd cmd="setddrrate @{ddr}"/>
                                                <sleep seconds="5"/>
                                                <SerialPortCmd cmd="setaxirate @{axi}"/>
                                                <sleep seconds="5"/>
                                                <sleep seconds="5"/>
                                                <echo message="setvolt vcc_main dvc0011 @{volt}"/>
                                                <SerialPortCmd cmd="setvolt vcc_main dvc0011 @{volt}" />
                                                <sleep seconds="5"/>

                                                <if>
                                                    <equals arg1="@{coreNum}" arg2="1"/>
                                                    <then>
                                                        <antcall target="one"/>
                                                    </then>
                                                    <elseif>
                                                        <equals arg1="@{coreNum}" arg2="2"/>
                                                        <then>
                                                            <antcall target="two"/>
                                                        </then>
                                                    </elseif>
                                                    <elseif>
                                                        <equals arg1="@{coreNum}" arg2="3"/>
                                                        <then>
                                                            <antcall target="three"/>
                                                        </then>
                                                    </elseif>
                                                    <elseif>
                                                        <equals arg1="@{coreNum}" arg2="4"/>
                                                        <then>
                                                            <antcall target="four"/>
                                                        </then>
                                                    </elseif>
                                                </if>
                                            </sequential>
                                        </for>
                                    </sequential>
                                </for>
                            </sequential>
                        </for>
                    </sequential>
                </for>
            </sequential>
        </for>
    </target>
    <target name="one">
        <SystemProperty key="description" value="${volt}, 1 core c1mp0"/>
        <echo message="set 3 core c2mp0, 1 core c1mp0"/>
        <SerialPortCmd cmd="lpm c2mp0 10000"/>
        <sleep seconds="5"/>
        <SerialPortCmd cmd="lpm c2mp0 10000"/>
        <sleep seconds="5"/>
        <SerialPortCmd cmd="lpm c2mp0 10000"/>
        <sleep seconds="5"/>
        <SerialPortCmd cmd="lcd_pwr 0"/>
        <sleep seconds="5"/>
        <SerialPortCmd cmd="lpm c1mp0 10000"/>
        <sleep seconds="5"/>
		<!-- measure power -->
        <antcall target="power"/>
    </target>

    <target name="two">
        <SystemProperty key="description" value="${volt}, 2 core c1mp0"/>
        <echo message="set 2 core c2mp0, 2 core c1mp0"/>
        <SerialPortCmd cmd="lpm c2mp0 10000"/>
        <sleep seconds="5"/>
        <SerialPortCmd cmd="lpm c2mp0 10000"/>
        <sleep seconds="5"/>
        <SerialPortCmd cmd="lpm c1mp0 10000"/>
        <sleep seconds="5"/>
        <SerialPortCmd cmd="lcd_pwr 0"/>
        <sleep seconds="5"/>
        <SerialPortCmd cmd="lpm c1mp0 10000"/>
        <sleep seconds="5"/>
		<!-- measure power -->
        <antcall target="power"/>
    </target>

    <target name="three">
        <SystemProperty key="description" value="${volt},3 core c1mp0"/>
        <echo message="set 1 core c2mp0, 3 core c1mp0"/>
        <SerialPortCmd cmd="lpm c2mp0 10000"/>
        <sleep seconds="5"/>
        <SerialPortCmd cmd="lpm c1mp0 10000"/>
        <sleep seconds="5"/>
        <SerialPortCmd cmd="lpm c1mp0 10000"/>
        <sleep seconds="5"/>
        <SerialPortCmd cmd="lcd_pwr 0"/>
        <sleep seconds="5"/>
        <SerialPortCmd cmd="lpm c1mp0 10000"/>
        <sleep seconds="5"/>
		<!-- measure power -->
        <antcall target="power"/>
    </target>

    <target name="four">
        <SystemProperty key="description" value="${volt},4 core in c1mp0"/>
        <echo message="set 4 core c1mp0"/>
        <SerialPortCmd cmd="lpm c1mp0 10000"/>
        <sleep seconds="5"/>
        <SerialPortCmd cmd="lpm c1mp0 10000"/>
        <sleep seconds="5"/>
        <SerialPortCmd cmd="lpm c1mp0 10000"/>
        <sleep seconds="5"/>
        <SerialPortCmd cmd="lcd_pwr 0"/>
        <sleep seconds="5"/>
        <SerialPortCmd cmd="lpm c1mp0 10000"/>
        <sleep seconds="5"/>
		<!-- measure power -->
        <antcall target="power"/>
    </target>

	<target name="power">
        <sleep seconds="20"/>
        <echo message="Power monitor start to work ..."/>
        <MeasurePower server="${power_server}" sample_t="30" voltage="4" save_f="c1mp0_cpu${cpu}_ddr${ddr}_axi${axi}_volt${volt}_${power_port}" port="${power_port}"/>
        <sleep seconds="5"/>
		<echo message="get power"/>
        <PowerResult file_n="c1mp0_cpu${cpu}_ddr${ddr}_axi${axi}_volt${volt}_${power_port}" server="${power_server}" stat_d="false"/>
        <copy file="${PT4_SERVER}/c1mp0_cpu${cpu}_ddr${ddr}_axi${axi}_volt${volt}_${power_port}.pt4" todir="${subcase_root}" failonerror="false"/>
        <sleep seconds="5"/>
        <echo message="reboot device to enter uboot again..."/>
        <EnterUboot/>
    </target>
    <target name="result" depends="run">
    </target>

</project>
