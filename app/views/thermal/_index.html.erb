<div class="tab-content">
	<div class="tab-pane">
             </div>
</div>

<div id="chart_container_thermal" style="min-width: 70%; height: 600px; margin: 0 auto;display:block;">
</div>
<div id="chart_container_battery" style="min-width: 70%; height: 600px; margin: 0 auto;display:none;">
</div>
<!-- Scripts -->
<script language="JavaScript">

    var dialog,form;

$(function () {
show_thermal();
    var comment = $( "#comment" ),
    email = $( "#email" ),
    passverify = $( "#passverify" ),
    failverify = $( "#failverify" ),
    imagedate=$("#imagedate"),
    casename=$("#casename"),
    power=$("#power"),
    soc=$("#soc"),
    os=$("#os"),
    allFields = $( [] ).add( comment ).add( email ).add( passverify ).add(failverify),
    tips = $( ".validateTips" );
    function updateTips( t ) {
      tips
        .text( t )
        .addClass( "ui-state-highlight" );
      setTimeout(function() {
        tips.removeClass( "ui-state-highlight", 1500 );
      }, 500 );
    }

    dialog = $( "#dialog-form" ).dialog({
      autoOpen: false,
      height: 350,
      width: 500,
      modal: true,
      buttons: {
        "Add comments": function() {
            var v = "TBD";
            if(passverify.attr('checked')){
                v = "P";
            }else if(failverify.attr('checked')){
                v = "F";
            }
            updateComment(imagedate.html(), casename.html(), power.html(), comment.val(), email.val(),v, soc.html(), os.html());

            allFields.removeClass( "ui-state-error" );
            $( this ).dialog( "close" );
        },
        Cancel: function() {
            $( this ).dialog( "close" );
        }
      },
      close: function() {
          form[0].reset();
          allFields.removeClass("ui-state-error");
      }
    });

    form = dialog.find("form").on("submit", function(event){
        event.preeventDefault();
    });

});
function show_battery(){
	//battery chart
	chart = new Highcharts.Chart({
	            chart: {
	                	renderTo: 'chart_container_battery'
	            },
	            title: {
	                text: 'Battery'
	            },
	            subtitle: {
	                text: null
	            },
	            xAxis: {
	                type: "datetime",
	                tickInterval: 24*3600*1000, // one day
	                tickColor:"#ff0000",
	                dateTimeLabelFormats:{
	                    day: '%m/%e'
	                }
	            },
	            yAxis: {
	                title: {
	                    text: 'Power'
	                },
	                labels: {
	                    formatter: function() {
	                        return this.value + 'mA'
	                    }
	                }
	            },
	            tooltip: {
	                useHTML: true,
	                formatter: function() {
	                    var hour=Highcharts.dateFormat('%H', this.x);
	                    hour /= 10;
	                    return '<b>'+ this.series.name +
	                            '</b><br/>'+
	                            Highcharts.dateFormat('%Y-%m-%d', this.x) +
	                            ' _ ('+hour + ')'+
	                            '<br/><b>'+
	                            this.y +'°C' +
	                            '</b>';
	                }
	            },
	            plotOptions: {
	                series: {
	                    cursor: 'pointer',
	                    point: {
	                        events: {
	                            click: function() {
	                            	show_temp_detail(this.series.name, Highcharts.dateFormat('%Y-%m-%d', this.x), this.y);
	                            }
	                        }
	                    },
	                    marker: {
	                        lineWidth: 1
	                    }
	                }
	            },
	            series: [
	            <% @thermal_scenarios.each do |scenario| %>
		<% @imagedatehour=0 %>
		<% @imagedate=0 %>
		{
			name: '<%= scenario.name %>',
		            	data: [
	            		<% @thermal.each do |record| %>
		            		<% if record.name == scenario.name %>
			            		{
						//如果日期相等
	                                            		<% if @imagedate == record.image_date %>
	                                                			<% @imagedatehour += 1 %>
	                                                			//判断是否超过24小时
	                                                			<% if @imagedatehour>=24 %>
	                                                    			<% @imagedatehour=23 %>
	                                                			<% end %>
	                                            		<% else %>
	                                                			<% @imagedatehour = 0 %>
	                                            		<% end %>
	                                    			<% @imagedate = record.image_date %>
			            			x: Date.UTC("<%= get_year(record.image_date) %>",
	                                                       			"<%= get_month(record.image_date) %>",
	                                                       			"<%= get_day(record.image_date) %>",
	                                                       			"<%= @imagedatehour %>" ),
	                                            		y: <%= record.battery %>,
			            		},
			            	<% end %>
	            		<% end %>]
		        },
	            <% end %>
	            ]//end series
	    });
}

function show_thermal(){
	//battery chart
	chart = new Highcharts.Chart({
	            chart: {
	                	renderTo: 'chart_container_thermal'
	            },
	            title: {
	                text: 'Thermal'
	            },
	            subtitle: {
	                text: null
	            },
	            xAxis: {
	                type: "datetime",
	                tickInterval: 24*3600*1000, // one day
	                tickColor:"#ff0000",
	                dateTimeLabelFormats:{
	                    day: '%m/%e'
	                }
	            },
	            yAxis: {
	                title: {
	                    text: 'Temperature'
	                },
	                labels: {
	                    formatter: function() {
	                        return this.value + '°C'
	                    }
	                }
	            },
	            tooltip: {
	                useHTML: true,
	                formatter: function() {
	                    var hour=Highcharts.dateFormat('%H', this.x);
	                    hour /= 10;
	                    return '<b>'+ this.series.name +
	                            '</b><br/>'+
	                            Highcharts.dateFormat('%Y-%m-%d', this.x) +
	                            ' _ ('+hour + ')'+
	                            '<br/><b>'+
	                            this.y +'°C' +
	                            '</b>'+
	                            '<br/>' +
	                            '<font color=\"#ff0000\">'+
	                            getComment(Highcharts.dateFormat('%Y-%m-%d', this.x), this.y) +
	                            '</font>';
	                }
	            },
	            plotOptions: {
	                series: {
	                    cursor: 'pointer',
	                    point: {
	                        events: {
	                            click: function() {

	                                var editcheckbox = $("#editcheckboxId");
	                                var name=this.series.name;
	                                var power=this.y;
	                                var comments = $.trim(getComment(Highcharts.dateFormat('%Y-%m-%d', this.x), this.y).toString());
	                                var verify = getVerify(Highcharts.dateFormat('%Y-%m-%d', this.x), this.y).toString();
	                                $("#imagedate").html(Highcharts.dateFormat('%Y-%m-%d', this.x));
	                                $("#casename").html(name);
	                                $("#power").html(power);
	                                $("#comment").html(comments);
	                                if(verify.indexOf("F") != -1){
	                                    $('input[name=verify]').get(1).checked=true;
	                                }else if(verify.indexOf("P") != -1){
	                                    $('input[name=verify]').get(0).checked=true;
	                                }
	                                //edit mode or show dutycycle mode
	                                if(editcheckbox.attr("checked")){
	                                    dialog.dialog( "open" );
	                                }else{
	                                    show_temp_detail(this.series.name, Highcharts.dateFormat('%Y-%m-%d', this.x), this.y);
	                                }
	                            }
	                        }
	                    },
	                    marker: {
	                        lineWidth: 1
	                    }
	                }
	            },
	            series: [
	            <% @thermal_scenarios.each do |scenario| %>
              	<% @imagedatehour=0 %>
                	<% @imagedate=0 %>
		{
			name: '<%= scenario.name %>',
		            	data: [
	            		<% @thermal.each do |record| %>
		            		<% if record.name == scenario.name %>
			            		{
	                                            		<% if @imagedate == record.image_date %>
	                                                			<% @imagedatehour += 1 %>
	                                                			<% if @imagedatehour>=24 %>
	                                                    			<% @imagedatehour=23 %>
	                                                			<% end %>
	                                            		<% else %>
	                                                			<% @imagedatehour = 0 %>
	                                            		<% end %>
	                                    			<% @imagedate = record.image_date %>
			            			x: Date.UTC("<%= get_year(record.image_date) %>",
	                                                       			"<%= get_month(record.image_date) %>",
	                                                       			"<%= get_day(record.image_date) %>",
	                                                       			"<%= @imagedatehour %>" ),
	                                            		y: <%= record.max_temp %>,
			                                    marker: {
			                                        <% if record.verified == "P" %>
			                                            fillColor: '#6dc22c'
			                                        <% else if record.verified == "F" %>
			                                            fillColor: '#ff0000'
			                                            <% end %>
			                                        <% end %>
			                                    }
			            		},
			            	<% end %>
	            		<% end %>]
		        },
	            <% end %>
	            ]//end series
	    });
}
function show_temp_detail(scenario, x_axis, y_axis){
	var task_url = "query?scenario=" + scenario + "&temp=" +y_axis + "&image_date=" + x_axis;
	    $.ajax({
	        type: "GET",
	        url: task_url,
	        success: function(msg){
	            $("footer").css("display","block");
	            $("#dc_info").append(msg);
	        }
	    });
}
</script>